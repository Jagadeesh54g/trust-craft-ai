  {/* Circuit symbol */}
  <span className="fixed left-10 top-10 animate-bounce-slow z-[100]" style={{animationDelay: '2.5s', opacity: 0.95}}>
      <svg width="40" height="40" fill="none" viewBox="0 0 24 24">
        <rect x="6" y="6" width="12" height="12" rx="3" fill="#38bdf8" opacity="0.85" />
        <circle cx="9" cy="9" r="1.5" fill="#fff" />
        <circle cx="15" cy="15" r="1.5" fill="#fff" />
        <path d="M9 9h6v6" stroke="#2563eb" strokeWidth="2" />
      </svg>
    </span>
  {/* Medal symbol */}
  <span className="fixed right-16 top-36 animate-bounce-slower z-[100]" style={{animationDelay: '3.1s', opacity: 0.95}}>
      <svg width="64" height="64" fill="none" viewBox="0 0 24 24">
        <circle cx="12" cy="10" r="6" fill="#f59e42" opacity="0.95" />
        <rect x="10" y="16" width="4" height="6" rx="1" fill="#fbbf24" />
        <path d="M12 16v6" stroke="#fff" strokeWidth="2" />
      </svg>
    </span>
  {/* Growth graph symbol */}
  <span className="fixed left-1/3 bottom-10 animate-bounce-slow z-[100]" style={{animationDelay: '3.7s', opacity: 0.95}}>
      <svg width="48" height="48" fill="none" viewBox="0 0 24 24">
        <rect x="4" y="17" width="4" height="3" rx="1" fill="#34d399" />
        <rect x="10" y="13" width="4" height="7" rx="1" fill="#34d399" />
        <rect x="16" y="9" width="4" height="11" rx="1" fill="#34d399" />
        <path d="M5 17l5-5 4 4 5-8" stroke="#10b981" strokeWidth="2" fill="none" />
      </svg>
    </span>
  {/* Star symbol */}
  <span className="fixed left-1/4 top-1/4 animate-bounce-slower z-[100]" style={{animationDelay: '1.8s', opacity: 0.95}}>
      <svg width="44" height="44" fill="none" viewBox="0 0 24 24">
        <polygon points="12,2 15,9 22,9.5 17,14.5 18.5,22 12,18.5 5.5,22 7,14.5 2,9.5 9,9" fill="#fbbf24" opacity="0.8" />
      </svg>
    </span>
  {/* Trophy symbol */}
  <span className="fixed right-1/5 bottom-1/4 animate-bounce-slow z-[100]" style={{animationDelay: '2.2s', opacity: 0.95}}>
      <svg width="50" height="50" fill="none" viewBox="0 0 24 24">
        <rect x="7" y="17" width="10" height="3" rx="1.5" fill="#fbbf24" />
        <rect x="9" y="4" width="6" height="10" rx="3" fill="#f59e42" />
        <path d="M7 7H4v2a5 5 0 005 5" stroke="#fbbf24" strokeWidth="2" />
        <path d="M17 7h3v2a5 5 0 01-5 5" stroke="#fbbf24" strokeWidth="2" />
      </svg>
    </span>
  {/* Lightbulb symbol */}
  <span className="fixed left-1/5 bottom-1/5 animate-bounce-slower z-[100]" style={{animationDelay: '2.7s', opacity: 0.95}}>
      <svg width="38" height="38" fill="none" viewBox="0 0 24 24">
        <ellipse cx="12" cy="10" rx="6" ry="8" fill="#a78bfa" opacity="0.7" />
        <rect x="10" y="18" width="4" height="4" rx="2" fill="#6366f1" />
      </svg>
    </span>
  {/* Target symbol */}
  <span className="fixed right-1/6 top-1/3 animate-bounce-slow z-[100]" style={{animationDelay: '2.3s', opacity: 0.95}}>
      <svg width="36" height="36" fill="none" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" fill="#38bdf8" opacity="0.2" />
        <circle cx="12" cy="12" r="6" fill="#2563eb" opacity="0.3" />
        <circle cx="12" cy="12" r="2" fill="#2563eb" />
      </svg>
    </span>
    {/* More floating symbols for visual interest */}
  {/* Authorization symbol (shield with check) */}
  <span className="fixed right-10 top-10 animate-bounce-slow z-[100]" style={{animationDelay: '1.2s', opacity: 0.95}}>
      <svg width="48" height="48" fill="none" viewBox="0 0 24 24">
        <path d="M12 3l7 4v5c0 5-3.5 9-7 9s-7-4-7-9V7l7-4z" fill="#2563eb" opacity="0.85" />
        <path d="M9.5 12.5l2 2 3-3.5" stroke="#fff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
      </svg>
    </span>
  {/* Certificate symbol (ribbon) */}
  <span className="fixed left-24 top-1/2 animate-bounce-slower z-[100]" style={{animationDelay: '2.1s', opacity: 0.95}}>
      <svg width="64" height="64" fill="none" viewBox="0 0 24 24">
        <circle cx="12" cy="10" r="6" fill="#fbbf24" opacity="0.95" />
        <path d="M12 16v4m0 0l-2-2m2 2l2-2" stroke="#f59e42" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
      </svg>
    </span>
  {/* Book symbol (open book) */}
  <span className="fixed right-1/4 bottom-20 animate-bounce-slower z-[100]" style={{animationDelay: '1.7s', opacity: 0.95}}>
      <svg width="56" height="56" fill="none" viewBox="0 0 24 24">
        <path d="M3 6a1 1 0 011-1h7v14H4a1 1 0 01-1-1V6zm17-1h-7v14h7a1 1 0 001-1V6a1 1 0 00-1-1z" fill="#a78bfa" opacity="0.95" />
        <path d="M12 5v14" stroke="#fff" strokeWidth="2" />
      </svg>
    </span>
    {/* Growth graph symbol (smaller, different position) */}
    <span className="absolute right-1/3 top-1/4 animate-bounce-slow z-20" style={{animationDelay: '2.9s'}}>
      <svg width="36" height="36" fill="none" viewBox="0 0 24 24">
        <rect x="4" y="17" width="4" height="3" rx="1" fill="#34d399" />
        <rect x="10" y="13" width="4" height="7" rx="1" fill="#34d399" />
        <rect x="16" y="9" width="4" height="11" rx="1" fill="#34d399" />
        <path d="M5 17l5-5 4 4 5-8" stroke="#10b981" strokeWidth="2" fill="none" />
      </svg>
    </span>
    {/* Medal symbol (smaller, different position) */}
    <span className="absolute left-1/2 bottom-8 animate-bounce-slower z-20" style={{animationDelay: '3.5s'}}>
      <svg width="36" height="36" fill="none" viewBox="0 0 24 24">
        <circle cx="12" cy="10" r="6" fill="#f59e42" opacity="0.95" />
        <rect x="10" y="16" width="4" height="6" rx="1" fill="#fbbf24" />
        <path d="M12 16v6" stroke="#fff" strokeWidth="2" />
      </svg>
    </span>
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { 
  Shield, 
  Users, 
  Briefcase, 
  Award, 
  CheckCircle, 
  ArrowRight,
  Github,
  Chrome,
  Linkedin
} from "lucide-react";
import { useState, useRef, useEffect } from "react";
import { useAuth } from "@/contexts/AuthContext";
import { supabase } from "@/integrations/supabase/client";
import { useNavigate } from "react-router-dom";

import { Link } from "react-router-dom";
import credifyLogo from "@/assets/Credify.png";
import IntroPage from "./IntroPage";

const Login = () => {
  const [isLogin, setIsLogin] = useState(true);
  const { login, register, oauthSignIn, isAuthenticated } = useAuth();
  const navigate = useNavigate();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [name, setName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [resendLoading, setResendLoading] = useState(false);
  const [resendSent, setResendSent] = useState(false);
  const [emailUnderVerification, setEmailUnderVerification] = useState<string | null>(null);
  const [emailVerified, setEmailVerified] = useState(false);
  const [verificationTimeout, setVerificationTimeout] = useState(false);
  const pollingRef = useRef<NodeJS.Timeout | null>(null);


  const features = [
    {
      icon: <Shield className="w-6 h-6" />,
      title: "AI-Powered Skill Verification",
      description: "Take comprehensive AI assessments to verify your technical skills. Get certified with blockchain-secured credentials that employers trust."
    },
    {
      icon: <Users className="w-6 h-6" />,
      title: "Trust-First Professional Network", 
      description: "Connect only with verified professionals. Every profile goes through AI validation to ensure authenticity and credibility."
    },
    {
      icon: <Briefcase className="w-6 h-6" />, 
      title: "Intelligent Job Matching",
      description: "Advanced AI algorithms match your verified skills with perfect opportunities. Get personalized recommendations based on your credibility score."
    }
  ];

  return (
    <div className="w-full min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-tr from-pink-400 via-yellow-300 to-green-300">
      {/* Floating symbols for login page (same as IntroPage) */}
      <span className="absolute left-10 top-10 animate-bounce-slow z-20" style={{animationDelay: '2.5s'}}>
        <svg width="40" height="40" fill="none" viewBox="0 0 24 24">
          <rect x="6" y="6" width="12" height="12" rx="3" fill="#38bdf8" opacity="0.85" />
          <circle cx="9" cy="9" r="1.5" fill="#fff" />
          <circle cx="15" cy="15" r="1.5" fill="#fff" />
          <path d="M9 9h6v6" stroke="#2563eb" strokeWidth="2" />
        </svg>
      </span>
      <span className="absolute right-16 top-36 animate-bounce-slower z-20" style={{animationDelay: '3.1s'}}>
        <svg width="64" height="64" fill="none" viewBox="0 0 24 24">
          <circle cx="12" cy="10" r="6" fill="#f59e42" opacity="0.95" />
          <rect x="10" y="16" width="4" height="6" rx="1" fill="#fbbf24" />
          <path d="M12 16v6" stroke="#fff" strokeWidth="2" />
        </svg>
      </span>
      <span className="absolute left-1/3 bottom-10 animate-bounce-slow z-20" style={{animationDelay: '3.7s'}}>
        <svg width="48" height="48" fill="none" viewBox="0 0 24 24">
          <rect x="4" y="17" width="4" height="3" rx="1" fill="#34d399" />
          <rect x="10" y="13" width="4" height="7" rx="1" fill="#34d399" />
          <rect x="16" y="9" width="4" height="11" rx="1" fill="#34d399" />
          <path d="M5 17l5-5 4 4 5-8" stroke="#10b981" strokeWidth="2" fill="none" />
        </svg>
      </span>
      <style>{`
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-24px); } }
        .animate-bounce-slow { animation: bounce-slow 3s infinite; }
        @keyframes bounce-slower { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-16px); } }
        .animate-bounce-slower { animation: bounce-slower 4.5s infinite; }
      `}</style>
      {/* Centered Login Form */}
      <div className="relative z-10 flex items-center justify-center w-full max-w-lg py-16">
        <Card className="w-full max-w-md bg-white/70 backdrop-blur-2xl shadow-xl animate-fade-in">
          <CardHeader className="text-center">
            <img 
              src={credifyLogo} 
              alt="Credify" 
              style={{height: '130px', width: '130px', margin: '0 auto 2rem auto', background: 'none'}}
            />
            <CardTitle className="text-2xl text-blue-900 font-bold mb-2">
              {isLogin ? "Sign in to Credify" : "Join Credify"}
            </CardTitle>
            <CardDescription className="text-blue-700">
              {isLogin 
                ? "Stay updated on your professional world"
                : "Create your verified professional profile"
              }
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6">
            {/* Social Login */}
            <div className="space-y-3">
              <Button variant="outline" className="w-full" size="lg" onClick={() => oauthSignIn('google')}>
                <Chrome className="w-5 h-5 mr-3" />
                Continue with Google
              </Button>
              <Button variant="outline" className="w-full" size="lg" onClick={() => oauthSignIn('linkedin')}>
                <Linkedin className="w-5 h-5 mr-3" />
                Continue with LinkedIn
              </Button>
              <Button variant="outline" className="w-full" size="lg" onClick={() => oauthSignIn('github')}>
                <Github className="w-5 h-5 mr-3" />
                Continue with GitHub
              </Button>
            </div>
            <div className="relative">
              <Separator />
              <span className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-card px-3 text-xs text-muted-foreground">
                OR
              </span>
            </div>
            {/* Email Form */}
            <form
              className="space-y-4"
              onSubmit={async (e) => {
                e.preventDefault();
                setError(null);
                setLoading(true);
                try {
                  if (isLogin) {
                    await login(email, password);
                    navigate("/feed");
                  } else {
                    await register(name, email, password);
                    setEmailUnderVerification(email);
                    setVerificationTimeout(false);
                  }
                } catch (err: any) {
                  const msg = err?.message || "Something went wrong";
                  setError(msg);
                } finally {
                  setLoading(false);
                }
              }}
            >
              {!isLogin && (
                <div className="space-y-2">
                  <Label htmlFor="name">Name</Label>
                  <Input 
                    id="name" 
                    type="text" 
                    placeholder="Enter your name"
                    className="h-11"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                  />
                </div>
              )}
              <div className="space-y-2">
                <Label htmlFor="email">Email</Label>
                <Input 
                  id="email" 
                  type="email" 
                  placeholder="Enter your email"
                  className="h-11"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="password">Password</Label>
                <Input 
                  id="password" 
                  type="password" 
                  placeholder="Enter your password"
                  className="h-11"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                />
              </div>
              {!isLogin && (
                <div className="space-y-2">
                  <Label htmlFor="confirmPassword">Confirm Password</Label>
                  <Input 
                    id="confirmPassword" 
                    type="password" 
                    placeholder="Confirm your password"
                    className="h-11"
                  />
                </div>
              )}
              {error && (
                <div className="text-sm text-red-500">{error}</div>
              )}

              {/* Show verification state */}
              {emailUnderVerification && !emailVerified && !verificationTimeout && (
                <div className="text-center text-blue-600 my-2">
                  Verification email sent to <b>{emailUnderVerification}</b>. Please check your inbox and verify your email.<br/>
                  <span>If verified, you will be signed up automatically.</span>
                  <div className="mt-2 text-xs text-gray-500">This will timeout in 2 minutes.</div>
                </div>
              )}
              {emailVerified && (
                <div className="text-center text-green-600 my-2">
                  Email verified! Your account is now active. You can sign in.
                </div>
              )}
              {verificationTimeout && emailUnderVerification && !emailVerified && (
                <div className="text-center text-red-600 my-2">
                  Verification timed out. Didn't receive the email?&nbsp;
                  <Button
                    type="button"
                    size="sm"
                    onClick={async () => {
                      setResendLoading(true);
                      setError(null);
                      try {
                        await supabase.auth.resend({ type: 'signup', email: emailUnderVerification });
                        setVerificationTimeout(false);
                        setEmailUnderVerification(emailUnderVerification);
                      } catch (e) {
                        setError('Failed to resend verification email.');
                      } finally {
                        setResendLoading(false);
                      }
                    }}
                    disabled={resendLoading}
                  >
                    {resendLoading ? 'Resending…' : 'Resend verification email'}
                  </Button>
                </div>
              )}
              {!emailUnderVerification && (
                <Button 
                  type="submit" 
                  className="w-full h-11 bg-primary hover:bg-primary/90"
                  disabled={loading}
                >
                  {isLogin ? (loading ? "Signing in..." : "Sign In") : (loading ? "Creating..." : "Create Account")}
                  <ArrowRight className="w-4 h-4 ml-2" />
                </Button>
              )}
              {error && error.toLowerCase().includes('confirm') && (
                <div className="mt-3 text-sm">
                  <div className="text-muted-foreground mb-2">Email not confirmed. Please verify your email to continue.</div>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    disabled={resendLoading || !email}
                    onClick={async () => {
                      setResendLoading(true);
                      try {
                        await supabase.auth.resend({ type: 'signup', email });
                        setResendSent(true);
                      } catch (e) {
                        // ignore; error will be surfaced minimally
                      } finally {
                        setResendLoading(false);
                      }
                    }}
                  >
                    {resendLoading ? 'Sending…' : resendSent ? 'Verification sent' : 'Resend verification email'}
                  </Button>
                </div>
              )}
            </form>
            <div className="flex flex-col gap-2 mt-6">
              <button
                onClick={() => setIsLogin(!isLogin)}
                className="text-sm text-blue-700 hover:underline"
              >
                {isLogin 
                  ? "New to Credify? Join now" 
                  : "Already on Credify? Sign in"
                }
              </button>
              {isLogin && (
                <button className="text-sm text-blue-500 hover:underline">
                  Forgot password?
                </button>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

export default Login;